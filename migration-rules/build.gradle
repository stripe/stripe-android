import io.gitlab.arturbosch.detekt.Detekt

plugins {
    id 'org.jetbrains.kotlin.jvm' version '2.1.10'
    id 'io.gitlab.arturbosch.detekt' version '1.23.7'
}

dependencies {
    testImplementation "junit:junit:4.13.2"
    testImplementation "com.google.truth:truth:1.4.4"
    
    // Detekt API for custom rules
    implementation "io.gitlab.arturbosch.detekt:detekt-api:1.23.7"
    implementation "io.gitlab.arturbosch.detekt:detekt-rules-style:1.23.7"
    
    // Add the compiled jar as a detekt plugin
    detektPlugins files(jar)
}

java {
    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_11
}

tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
    kotlinOptions {
        jvmTarget = "11"
    }
}

// Create migration directory if it doesn't exist
def migrationConfigDir = file("config/detekt")
if (!migrationConfigDir.exists()) {
    migrationConfigDir.mkdirs()
}

// Create migration config file if it doesn't exist
def migrationConfigFile = file("config/detekt/migration.yml")
if (!migrationConfigFile.exists()) {
    migrationConfigFile.createNewFile()
    migrationConfigFile.text = """
stripe-v25-migration:
  active: true
  RememberPaymentSheetMigration:
    active: true
  RememberPaymentSheetFlowControllerMigration:
    active: true
  ClassMigration:
    active: true
"""
}

// Add the migration tasks
tasks.register('detektMigration', Detekt) {
    description = 'Run detekt with v25 migration rules'
    group = 'migration'
    
    dependsOn jar

    buildUponDefaultConfig = false
    parallel = false  // Disable parallel execution to avoid concurrent modifications
    autoCorrect = true
    config.setFrom(files("config/detekt/migration.yml"))
//    setSource(files("${projectDir}"))
    setSource(files("/Users/cttsai/stripe/stripe-android/paymentsheet/src/main/java/com/stripe/android/common/analytics/testfile.kt"))
    include("**/*.kt")
    exclude("**/build/**", "**/migration-rules/**")
}
tasks.withType(Detekt).configureEach {
    reports {
        html.required.set(true) // observe findings in your browser with structure and code snippets
        xml.required.set(true) // checkstyle like format mainly for integrations like Jenkins
        txt.required.set(true) // simple text format
    }
}
tasks.withType(Detekt).configureEach {
    jvmTarget = "1.8"
}

tasks.register('migrateToV25') {
    group = 'migration'
    description = 'Migrates codebase from Stripe Android SDK v21+ to v25'
    dependsOn 'detektMigration'

    doLast {
        println "\nüéâ Migration analysis completed!"
        println "üìã Check the detekt reports for migration suggestions:"
        println "   - HTML: build/reports/detekt/detekt.html"
        println "   - Text: build/reports/detekt/detekt.txt"
        println "üìù Copy-paste the suggested replacements into your code"
        println "üêõ Report issues at: https://github.com/stripe/stripe-android/issues"
    }
}
