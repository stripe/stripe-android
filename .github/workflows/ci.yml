name: CI
on:
  push:
    branches:
      - master
  pull_request:

env:
  STRIPE_END_TO_END_TESTS_BACKEND_URL: ${{ secrets.STRIPE_END_TO_END_TESTS_BACKEND_URL }}

jobs:
  instrumentation-tests:
    name: Instrumentation tests
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '11'

      - name: Instrumentation tests
        uses: reactivecircus/android-emulator-runner@v2.22.0
        with:
          api-level: 29
          arch: x86
          profile: Galaxy Nexus
          target: google_apis
          force-avd-creation: false
          cores: 3
          ram-size: 8192M
          disable-animations: true
          script: |
            ./gradlew :paymentsheet-example:connectedAndroidTest -Dorg.gradle.jvmargs="-XX:MaxHeapSize=2048m -Xmx4608M"
            adb pull /data/data/com.stripe.android.paymentsheet.example.files paymentsheet-example
            adb -s emulator-5558 logcat -e ".*com.stripe.android.paymentsheet.example.*" -t 1000 > paymentsheet-example/logcat.log
        env:
          STRIPE_EXAMPLE_BACKEND_URL: ${{ secrets.STRIPE_EXAMPLE_BACKEND_URL }}
          STRIPE_EXAMPLE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_EXAMPLE_PUBLISHABLE_KEY }}

      - uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: instrumentation-test-report
          path: |
            paymentsheet-example/build/reports/androidTests/connected/index.html
            paymentsheet-example/*.png
            paymentsheet-example/*.xml
            paymentsheet-example/logcat.log
