name: CI
on:
    push:
        branches:
            - master
    pull_request:
jobs:
    check:
        name: Check
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - uses: actions/checkout@v2
            - uses: gradle/wrapper-validation-action@v1
            - uses: actions/setup-java@v1
              with:
                  java-version: 8
            - uses: actions/cache@v1
              with:
                path: ~/.gradle/caches
                key: gradle-${{ runner.os }}-${{ hashFiles('**/build.gradle') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
            - name: Ktlint
              run: ./gradlew ktlint
            - name: Checkstyle
              run: ./gradlew checkstyle
            - name: Lint
              run: ./gradlew lintRelease

            # Check if there has been a binary incompatible change to the API.
            # If this change is intentional, run `./gradlew apiDump` and commit the new API files.
            - name: Check binary compatibility
              run: ./gradlew apiCheck

    unit-tests:
        name: Unit tests
        runs-on: ubuntu-latest
        timeout-minutes: 35
        steps:
            - uses: actions/checkout@v2
            - uses: gradle/wrapper-validation-action@v1
            - uses: actions/setup-java@v1
              with:
                  # use Java 8 for Locale and Currency compatibility with Android
                  java-version: 8
            - uses: actions/cache@v1
              with:
                path: ~/.gradle/caches
                key: gradle-${{ runner.os }}-${{ hashFiles('**/build.gradle') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
            - name: Unit tests
              run: ./gradlew testDebugUnitTest
            - uses: actions/upload-artifact@v2
              if: failure()
              with:
                name: unit-test-report
                path: stripe/build/reports/tests/testDebugUnitTest/

    end-to-end-tests:
      name: End-to-end tests
      runs-on: ubuntu-latest
      timeout-minutes: 5
      steps:
        - uses: actions/checkout@v2
        - name: Populate gradle.properties
          # Write secrets to location accessible by Gradle
          # See https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_configuration_properties
          env:
            ACTIONS_ALLOW_UNSECURE_COMMANDS: true
            BACKEND_URL: ${{ secrets.STRIPE_END_TO_END_TESTS_BACKEND_URL }}
            PUBLISHABLE_KEY: ${{ secrets.STRIPE_END_TO_END_TESTS_PUBLISHABLE_KEY }}
          shell: bash
          run: |
            echo "STRIPE_END_TO_END_TESTS_BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
            echo "STRIPE_END_TO_END_TESTS_PUBLISHABLE_KEY=${PUBLISHABLE_KEY}" >> $GITHUB_ENV

            mkdir -p ~/.gradle/
            echo "::set-env name=GRADLE_USER_HOME::$HOME/.gradle"
            echo "STRIPE_END_TO_END_TESTS_BACKEND_URL=${BACKEND_URL}" >> ~/.gradle/gradle.properties
            echo "STRIPE_END_TO_END_TESTS_PUBLISHABLE_KEY=${PUBLISHABLE_KEY}" >> ~/.gradle/gradle.properties
        - uses: gradle/wrapper-validation-action@v1
        - uses: actions/setup-java@v1
          with:
            # use Java 8 for Locale and Currency compatibility with Android
            java-version: 8
        - uses: actions/cache@v1
          with:
            path: ~/.gradle/caches
            key: gradle-${{ runner.os }}-${{ hashFiles('**/build.gradle') }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}
        - name: Unit tests
          run: ./gradlew :stripe-test-e2e:testDebugUnitTest
        - uses: actions/upload-artifact@v2
          if: failure()
          with:
            name: unit-test-report
            path: stripe-test-e2e/build/reports/tests/testDebugUnitTest/
