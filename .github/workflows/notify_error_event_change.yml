name: Notify UnexpectedErrorEvent Change
on:
  pull_request:
    types: [opened, labeled, unlabeled, synchronize]
    paths:
      - 'payments-core/src/main/java/com/stripe/android/payments/core/analytics/ErrorReporter.kt'

jobs:
  validate-error-event-change:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if UnexpectedErrorEvent was modified
        id: check_unexpected_error
        run: |
          # Get the diff for the ErrorReporter.kt file
          git diff -U1000 origin/${{ github.base_ref }}...HEAD -- payments-core/src/main/java/com/stripe/android/payments/core/analytics/ErrorReporter.kt > diff.txt

          # Check if UnexpectedErrorEvent enum was modified (lines added or removed within the enum)
          if grep -A 200 'enum class UnexpectedErrorEvent' diff.txt | grep -E '^\+.*[A-Z_]+\(' > /dev/null; then
            echo "unexpected_error_modified=true" >> $GITHUB_OUTPUT
            echo "UnexpectedErrorEvent enum was modified"
          else
            echo "unexpected_error_modified=false" >> $GITHUB_OUTPUT
            echo "UnexpectedErrorEvent enum was not modified"
          fi

      - uses: peter-evans/find-comment@a54c31d7fa095754bfef525c0c8e5e5674c4b4b1
        if: steps.check_unexpected_error.outputs.unexpected_error_modified == 'true'
        id: find_comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: UnexpectedErrorEvent Change Detected

      - uses: peter-evans/create-or-update-comment@67dcc547d311b736a8e6c5c236542148a47adc3d
        if: steps.check_unexpected_error.outputs.unexpected_error_modified == 'true'
        with:
          body: |
            UnexpectedErrorEvent Change Detected

            This PR modifies the `UnexpectedErrorEvent` enum in `ErrorReporter.kt`.

            **Action Required:** Please ensure you have added the new error event to the `https://git.corp.stripe.com/stripe-internal/zoolander/blob/master/src/resources/com/stripe/dscore/analyticseventlogger/server/rpcserver/client_config.yaml` file in the `pay-server` repository.

            Once you have verified that the error event has been added to `client_config.yaml`, please add the label `added-to-client-config` to this PR to acknowledge this requirement.

            This ensures that our unexpected error events detector will fire if this new unexpected error is detected.
          edit-mode: replace
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail if not acknowledged
        if: steps.check_unexpected_error.outputs.unexpected_error_modified == 'true' && !contains(github.event.pull_request.labels.*.name, 'added-to-client-config')
        run: |
          echo "::error::UnexpectedErrorEvent was modified but 'added-to-client-config' label is missing"
          echo "Please add the label 'added-to-client-config' after updating client_config.yaml in pay-server"
          exit 1
